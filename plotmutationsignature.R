#
# library(deconstructSigs)
# #write the subtypes
# filecon=file("mutationsubtypes.txt",'w')
# for (i in 1:ncol(example.output$tumor))
# {
#   writeLines(colnames(example.output$tumor)[i],filecon)
# }
# close(filecon)
plotsignature=function (signature, sub = "") 
{
  #signature: matrix 1 by 96, rowname: title
  #      A[C>A]A     A[C>A]C      A[C>A]G     A[C>A]T   ...
  # 1 0.001314202 0.001961651 9.687434e-05 0.002529105  ...
  op <- graphics::par()
  signature <- as.matrix(signature)
  y_limit <- 1.2 * max(signature)
  tumor_plotting <- formatContexts(signature)
  name <- unique(tumor_plotting$sample.id)
  subtype <- sub
  if (subtype == "") {
    top.title <- name
  }
  if (subtype != "") {
    top.title <- paste(name, " -- ", subtype, sep = "")
  }
  grDevices::palette(c("#999999", "#E69F00", "#56B4E9", "#009E73", 
                       "#F0E442", "#0072B2"))
  graphics::barplot(tumor_plotting$fraction, names.arg = tumor_plotting$full_context, 
                    cex.names = 0.7, las = 2, col = NA, ylim = c(0, y_limit), 
                    border = NA, xaxt = "n", ann = FALSE, yaxt = "n", space = 0.3)
  graphics::box()
  x = graphics::par("usr")
  graphics::abline(h = seq(from = 0, to = y_limit, by = 0.01), 
                   col = "#d3d3d350", lty = 1)
  graphics::abline(v = seq(from = x[1], to = x[2], by = 1), 
                   col = "#d3d3d350", lty = 1)
  graphics::barplot(tumor_plotting$fraction, names.arg = tumor_plotting$full_context, 
                    cex.names = 0.7, cex.lab=1.5,las = 2, col = factor(tumor_plotting$mutation), 
                    ylim = c(0, y_limit), border = NA, space = 0.3, main = top.title, 
                    ylab = "fraction", add = TRUE)
  graphics::legend("topright", legend = unique(tumor_plotting$mutation), 
                   col = c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
                           "#0072B2"), bty = "n", ncol = 6, inset = c(-0, 0), 
                   pch = 15, xpd = TRUE, pt.cex = 4)
  on.exit(suppressWarnings(graphics::par(op)))
}


formatContexts=function (contexts) 
{
  for_plotting = reshape2::melt(contexts)
  colnames(for_plotting)[1] = "sample.id"
  colnames(for_plotting)[2] = "full_context"
  colnames(for_plotting)[3] = "fraction"
  for_plotting$mutation = substr(for_plotting$full_context, 
                                 3, 5)
  for_plotting$full_context = as.factor(for_plotting$full_context)
  for_plotting$full_context = factor(for_plotting$full_context, 
                                     levels = for_plotting$full_context, ordered = T)
  return(for_plotting)
}



plotsignature1=function (signature, name, y_limit,sub = "") 
{
  #signature: matrix 1 by 96, rowname: title
  #      A[C>A]A     A[C>A]C      A[C>A]G     A[C>A]T   ...
  # 1 0.001314202 0.001961651 9.687434e-05 0.002529105  ...
  op <- graphics::par()
  signature <- as.matrix(signature)
  #y_limit <- 1.2 * max(signature)
  tumor_plotting <- formatContexts(signature)
  #name <- unique(tumor_plotting$sample.id)
  subtype <- sub
  if (subtype == "") {
    top.title <- name
  }
  if (subtype != "") {
    top.title <- paste(name, " -- ", subtype, sep = "")
  }
  grDevices::palette(c("skyblue", "black", "red", "gray", 
                       "forestgreen", "tan3"))
  graphics::barplot(tumor_plotting$fraction, names.arg = "", 
                    cex.names = 0.7, las = 2, col = NA, ylim = c(0, y_limit), 
                    border = NA, xaxt = "n", ann = FALSE, yaxt = "n", space = 0.3)
  graphics::box()
  x = graphics::par("usr")
  graphics::abline(h = seq(from = 0, to = y_limit, by = 0.01), 
                   col = "#d3d3d350", lty = 1)
  graphics::abline(v = seq(from = x[1], to = x[2], by = 1), 
                   col = "#d3d3d350", lty = 1)
  graphics::barplot(tumor_plotting$fraction, names.arg ="", 
                    cex.names = 0.7, cex.lab=1.5,las = 2, col = factor(tumor_plotting$mutation), 
                    ylim = c(0, y_limit), border = NA, space = 0.3, main = top.title, 
                    ylab = "fraction", add = TRUE)
#   graphics::legend("topright", legend = unique(tumor_plotting$mutation), 
#                    col = c("skyblue", "black", "red", "gray", "forestgreen", 
#                            "tan3"), bty = "n", ncol = 6, inset = c(-0, 0), 
#                    pch = 15, xpd = TRUE, pt.cex = 4)
  #on.exit(suppressWarnings(graphics::par(op)))
}

#args <- commandArgs(trailingOnly = TRUE)
#mutationsignaturefile=as.character(args[1])

#mutationsignaturefile was generated by savesignature.sh
#mutationsignaturefile="henan_varscan_3_signatures.txt"
mutationsignaturefile="henan_varscan1_2_signatures.txt"
mutationsignaturefile="henan_varscan_2_signatures.txt"
mutationsignaturefile="dulak_varscan_2_signatures.txt"

mutationsignaturefile="henan_varscan1_1_signatures.txt"
mutationsignaturefile="henan_varscan_1_signatures.txt"
mutationsignaturefile="dulak_varscan_1_signatures.txt"

mutationsubtypes=read.table(file="mutationsubtypes.txt")


#dulak:
mutationsignaturefile="dulak_varscan_1_signatures.txt"
# names=c("Mutagenic")
names=c("US-EA")
y_limit=0.1

mutationsignaturefile="dulak_varscan_2_signatures.txt"
mutationsignaturefile="dulak_varscan2_2_signatures.txt"
mutationsignaturefile="dulak_varscan2_1_signatures.txt"
dataname="dulak"
names=c("Mutagenic","S2")
y_limit=0.18

#henan:
mutationsignaturefile="henan_varscan_1_signatures.txt"
# names=c("S3")
names=c("CH-EA")
y_limit=0.1

mutationsignaturefile="henan_varscan_2_signatures.txt"
mutationsignaturefile="henan_varscan2_2_signatures.txt"
mutationsignaturefile="henan_varscan2_1_signatures.txt"
dataname="henan"
names=c("S2"," ")
y_limit=0.1

#golden4
mutationsignaturefile="henan_golden4_1_signatures.txt"
# names=c("S2")
names=c("CH-ESCC-Golden4")
y_limit=0.1
dataname="golden4"


#escc
mutationsignaturefile="escc_varscan2_2_signatures.txt"
# mutationsignaturefile="escc_varscan2_1_signatures.txt"
dataname="escc"
names=c("S2","S1")
names=c("CH-ESCC")
y_limit=0.1

mutationsignature=read.table(file=mutationsignaturefile)
mutationsignature=t(mutationsignature)
colnames(mutationsignature)=mutationsubtypes[,1]
mutationtypes=c('C>A','C>G','C>T','A>T','A>G','A>C')
mutationcols=c("skyblue", "black", "red", "gray", "forestgreen", "tan3")
ats=c()
xs=c(1,3,5,7,9,11)
len=(par("usr")[2]-par("usr")[1])/(6+2/3)
for (i in 1:6)
{
  ats[i]=par("usr")[1]+1/3*len+xs[i]*len/2
}

for (i in 1:nrow(mutationsignature))
{
  mat=as.matrix(t(mutationsignature[i,]),nrow=1,ncol=96)
  #rownames(mat)=paste0("signature",i)
  #plotsignature1(mat,names[i],y_limit,sub=dataname)
  plotsignature1(mat,names[i],y_limit)
  #text(c(0.15,0.3,0.45,0.6,0.75,0.9),rep(-0.1,6),c('C>A','C>G','C>T','T>A','T>C','T>G'),col=c("skyblue", "black", "red", "gray", "forestgreen", "tan3"),cex=1.3)
  #text(c(0.7,1.4,1.9,2.4,2.9,3.4),rep(-0.5,6),c('C>A','C>G','C>T','T>A','T>C','T>G'),col=c("skyblue", "black", "red", "gray", "forestgreen", "tan3"),cex=1.3)
  for (j in 1:length(mutationtypes))
  {
    mtext(mutationtypes[j],side=1,line=1,at=ats[j],col=mutationcols[j])
  }
}



